name: Sync API Data

on:
  # Run when settings.json is updated (we'll check if apiSyncTrigger changed)
  # DISABLED for 2024 season - will re-enable next year
  # push:
  #   paths:
  #     - '_content/settings/settings.json'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual sync'
        required: false
        default: 'Manual trigger'
        type: string

jobs:
  sync-api:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 2

      - name: Check if apiSyncTrigger changed
        id: check-trigger
        if: github.event_name == 'push'
        run: |
          # Extract apiSyncTrigger value from JSON using node (more reliable than sed/grep)
          node -e "
            const fs = require('fs');
            const extractValue = (file) => {
              try {
                const content = fs.readFileSync(file, 'utf8');
                const json = JSON.parse(content);
                return json.apiSyncTrigger || '';
              } catch (e) {
                return '';
              }
            };

            const oldFile = '_content/settings/settings.json.old';
            const newFile = '_content/settings/settings.json';

            // Get previous version from git
            let oldValue = '';
            try {
              const { execSync } = require('child_process');
              const prevContent = execSync('git show HEAD~1:_content/settings/settings.json', { encoding: 'utf8' });
              fs.writeFileSync(oldFile, prevContent);
              oldValue = extractValue(oldFile);
            } catch (e) {
              // Previous commit doesn't have the file, assume changed
              process.exit(1);
            }

            const newValue = extractValue(newFile);

            if (oldValue !== newValue) {
              console.log('âœ… apiSyncTrigger changed from', oldValue, 'to', newValue);
              process.exit(0); // Changed
            } else {
              console.log('â­ï¸  apiSyncTrigger unchanged:', newValue);
              process.exit(2); // Unchanged
            }
          " && echo "trigger_changed=true" >> $GITHUB_OUTPUT || EXIT_CODE=$?

          if [ "$EXIT_CODE" = "2" ]; then
            echo "trigger_changed=false" >> $GITHUB_OUTPUT
          elif [ "$EXIT_CODE" != "0" ]; then
            # Error or file didn't exist - assume changed to be safe
            echo "trigger_changed=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Assuming trigger changed (first commit or error checking)"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        if: github.event_name == 'workflow_dispatch' || steps.check-trigger.outputs.trigger_changed == 'true'
        run: npm ci

      - name: Run API sync
        if: github.event_name == 'workflow_dispatch' || steps.check-trigger.outputs.trigger_changed == 'true'
        env:
          FESTICINE_API_USERNAME: ${{ secrets.FESTICINE_API_USERNAME }}
          FESTICINE_API_PASSWORD: ${{ secrets.FESTICINE_API_PASSWORD }}
        run: npm run sync-api

      - name: Check for changes
        if: github.event_name == 'workflow_dispatch' || steps.check-trigger.outputs.trigger_changed == 'true'
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: (github.event_name == 'workflow_dispatch' || steps.check-trigger.outputs.trigger_changed == 'true') && steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add _content/events/ _content/entries/
          git commit -m "ðŸ”„ Auto-sync API data from festicine.pro

          - Updated events and entries from API
          - Preserved manual edits
          - Generated on $(date)
          - Trigger: ${{ github.event.inputs.reason || 'Settings update' }}"
          git push
